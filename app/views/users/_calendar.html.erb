<% season_icon = { "spring" => "üå∏", "summer" => "üåª", "autumn" => "üçÅ", "winter" => "‚ùÑÔ∏è" }[@season] %>
<% type_icon = { "future" => "üå±", "organize" => "üåà", "thanks" => "üíå" } %>

<div class="calendar-container <%= @season %>" data-season="<%= @season %>">
  <div class="flex items-center justify-between mb-6">
    <%= link_to "‚Üê",
      mypage_path(year: @month == 1 ? @year - 1 : @year,
                  month: @month == 1 ? 12 : @month - 1),
      data: { turbo_frame: "calendar_frame" },
      class: "month-nav text-2xl font-bold text-gray-600 hover:text-gray-800 transition-colors duration-200" %>

    <h2 class="text-2xl font-bold text-gray-800">
      <%= "#{@year}Âπ¥ #{@month}Êúà #{season_icon}" %>
    </h2>

    <%= link_to "‚Üí",
      mypage_path(year: @month == 12 ? @year + 1 : @year,
                  month: @month == 12 ? 1 : @month + 1),
      data: { turbo_frame: "calendar_frame" },
      class: "month-nav text-2xl font-bold text-gray-600 hover:text-gray-800 transition-colors duration-200" %>
  </div>

  <div class="grid grid-cols-7 gap-3 mb-3">
    <% ["Êó•","Êúà","ÁÅ´","Ê∞¥","Êú®","Èáë","Âúü"].each_with_index do |day, i| %>
      <div class="text-center text-sm font-bold <%= i == 0 ? 'text-red-500' : i == 6 ? 'text-blue-500' : 'text-gray-600' %>">
        <%= day %>
      </div>
    <% end %>
  </div>

  <div class="grid grid-cols-7 gap-3">
    <% @first_day.wday.times { %><div></div><% } %>

    <% @dates.each do |date| %>
      <% day_posts = (@posts_by_date || {})[date] || [] %>
      <% classes = ["calendar-day", "border", "border-gray-300", "relative"] %>
      <% classes << "today" if date == Time.zone.today.to_date %>
      <% classes << "has-post" if day_posts.any? %>

      <% if day_posts.any? %>
        <div data-controller="calendar-tooltip"
             data-action="mouseenter->calendar-tooltip#show
                          mouseleave->calendar-tooltip#scheduleHide
                          click->calendar-tooltip#togglePin"
             class="<%= classes.join(' ') %>">
          <%= date.day %>

          <div data-calendar-tooltip-target="tooltip"
               data-action="mouseenter->calendar-tooltip#cancelHide
                            mouseleave->calendar-tooltip#scheduleHide"
               class="calendar-tooltip hidden absolute z-20 left-1/2 -translate-x-1/2 bottom-[120%]
                      bg-gradient-to-br from-[#fff8f5] to-[#ffe4dc]
                      text-gray-800 rounded-xl shadow-xl p-3 border border-rose-200
                      w-60 text-sm backdrop-blur-md pointer-events-auto">
            <% day_posts.first(3).each do |p| %>
              <%= link_to post_path(p), data: { turbo: false },
                          class: "block hover:bg-gray-100 rounded-md px-2 py-1 transition" do %>
                <div class="flex items-center gap-1">
                  <span><%= type_icon[p.post_type] || "" %></span>
                  <span class="truncate"><%= truncate((p.title.presence || strip_tags(p.body)), length: 28) %></span>
                  <% unless p.is_public %>
                    <span class="text-gray-500 text-xs">üîí</span>
                  <% end %>
                </div>
              <% end %>
            <% end %>

            <% if day_posts.size > 3 %>
              <div class="text-xs text-gray-500 mt-1 text-right">
                ‰ªñ <%= day_posts.size - 3 %> ‰ª∂
              </div>
            <% end %>
          </div>
        </div>
      <% else %>
        <div class="<%= classes.join(' ') %> text-center py-1"><%= date.day %></div>
      <% end %>
    <% end %>
  </div>

  <div class="legend-box mt-4">
    <div class="legend-item">
      <div class="legend-color bg-gradient-to-br from-[#fffdfb] to-[#fff3ef] border border-gray-300"></div>
      <span>ÊäïÁ®ø„Å™„Åó</span>
    </div>
    <div class="legend-item">
      <div class="legend-color bg-gradient-to-br from-orange-400 to-pink-400 border border-pink-300"></div>
      <span>ÊäïÁ®ø„ÅÇ„Çä</span>
    </div>
    <div class="legend-item">
      <div class="legend-color bg-gradient-to-br from-[#fff9f7] to-[#ffe7e0] border-2 border-rose-300 animate-pulse"></div>
      <span>‰ªäÊó•</span>
    </div>
  </div>
</div>
