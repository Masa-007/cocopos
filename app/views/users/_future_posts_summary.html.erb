<!-- 🌱 未来宣言箱（TODO / 進捗 / 期限） -->
<div class="bg-white rounded-3xl border-2 border-green-200 shadow-md p-6 mb-10 narrow-summary-box">
  <!-- ヘッダー -->
  <div class="flex flex-col items-center text-left mb-1">
    <h2 class="text-xl md:text-2xl font-bold text-gray-800">
      🌱 未来宣言箱のTODOメモ
    </h2>
    <p class="text-sm text-gray-500">
      タイトル・進捗・期限を月ごとに確認できます。
    </p>
  </div>

  <!-- 補足テキスト -->
  <p class="text-sm text-gray-500 text-center mb-2 whitespace-pre-line leading-relaxed">
    <%= future_insight %>
  </p>

  <%= render "users/future_achieved_rate" %>
  
  <% base_params = { year: @year, month: @month, season: @season } %>
  <% filter_path = local_assigns.fetch(:filter_path, method(:mypage_path)) %>

  <div class="mb-6 flex flex-wrap justify-center gap-2 text-sm font-semibold">
    <%= link_to "すべて",
          filter_path.call(base_params.merge(todo_filter: "all")),
          class: "rounded-full border px-4 py-1 shadow-sm transition #{ @todo_filter == 'all' ? 'bg-green-600 text-white border-green-600' : 'bg-white text-gray-600 border-green-100 hover:bg-green-50' }" %>

    <%= link_to "未達成",
          filter_path.call(base_params.merge(todo_filter: "unachieved")),
          class: "rounded-full border px-4 py-1 shadow-sm transition #{ @todo_filter == 'unachieved' ? 'bg-green-600 text-white border-green-600' : 'bg-white text-gray-600 border-green-100 hover:bg-green-50' }" %>

    <%= link_to "達成済み",
          filter_path.call(base_params.merge(todo_filter: "achieved")),
          class: "rounded-full border px-4 py-1 shadow-sm transition #{ @todo_filter == 'achieved' ? 'bg-green-600 text-white border-green-600' : 'bg-white text-gray-600 border-green-100 hover:bg-green-50' }" %>
  </div>

  <% if future_posts.present? %>
    <div class="space-y-5">
      <% future_posts.each do |post| %>
                <%= link_to post_path(post, from: "mypage_records"), data: { turbo_frame: "_top" }, class: "block" do %>
          <div class="rounded-2xl border border-green-100 bg-green-50/40 p-4 transition hover:bg-green-100/50 hover:shadow-sm">
            <div class="flex flex-col items-center gap-5 text-center">
              <!-- TODO 情報 -->
              <div class="w-full">
                <p class="text-sm text-green-700 font-semibold">TODO</p>

                <h3 class="text-lg font-bold text-gray-800 break-words">
                  <%= post.title.presence || "タイトル未設定" %>
                </h3>

                <p class="text-sm text-gray-500 mt-1">
                  <%= l post.created_at, format: :short %> 投函
                </p>
              </div>

              <!-- 進捗・期限 -->
              <div class="flex flex-col items-center gap-4 text-sm text-gray-700 w-full">
                <div class="flex items-center justify-center gap-3 flex-wrap w-full">
                  <span class="inline-flex items-center gap-1 rounded-full bg-white px-3 py-1 shadow-sm">
                    🎯 進捗
                    <strong><%= post.progress.present? ? "#{post.progress}%" : "未設定" %></strong>
                  </span>

                  <span class="inline-flex items-center gap-1 rounded-full bg-white px-3 py-1 shadow-sm">
                    📅 期限
                    <strong><%= post.deadline.present? ? l(post.deadline, format: :short) : "未設定" %></strong>
                  </span>
                </div>

                <!-- プログレスバー -->
                <div class="h-2 w-full max-w-md mx-auto rounded-full bg-white/70 shadow-inner">
                  <div
                    class="h-full rounded-full bg-green-400"
                    style="width: <%= post.progress.present? ? post.progress : 0 %>%;">
                  </div>
                </div>
              </div>
            </div>
          </div>
        <% end %>
      <% end %>
    </div>
  <% else %>
    <p class="text-sm text-gray-500 text-center">
      <% if @todo_filter == 'unachieved' && @achieved_future_count.to_i.positive? %>
        未達成のTODOはありません。
      <% else %>
        この月には未来宣言箱の投稿がありません。
      <% end %>
    </p>
  <% end %>
</div>

