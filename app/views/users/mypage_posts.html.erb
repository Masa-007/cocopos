<main class="flex-grow pt-24 pb-12">
  <div class="container mx-auto max-w-6xl px-6">

    <div class="text-center mb-10">
      <h1 class="text-4xl font-bold text-gray-800 mb-2">📮 あなたの投稿一覧</h1>
      <p class="text-gray-600">これまで投函した想いを振り返りましょう</p>
    </div>

    <%= render "posts/search_form" %>

    <div class="filter-bar flex flex-col md:flex-row md:items-center md:justify-between mb-8 gap-4">
      <div class="filter-buttons flex flex-wrap items-center gap-2">
        <span class="filter-label font-semibold text-gray-700">箱の種類：</span>

        <%= link_to "すべて", mypage_posts_path(filter: 'all', sort: params[:sort]),
              data: { turbo: false },
              class: "filter-btn #{'active' if params[:filter].blank? || params[:filter] == 'all'}" %>

        <%= link_to "🌱 未来宣言箱", mypage_posts_path(filter: 'future', sort: params[:sort]),
              data: { turbo: false },
              class: "filter-btn #{'active' if params[:filter] == 'future'}" %>

        <%= link_to "🌈 心の整理箱", mypage_posts_path(filter: 'organize', sort: params[:sort]),
              data: { turbo: false },
              class: "filter-btn #{'active' if params[:filter] == 'organize'}" %>

        <%= link_to "💌 感謝箱", mypage_posts_path(filter: 'thanks', sort: params[:sort]),
              data: { turbo: false },
              class: "filter-btn #{'active' if params[:filter] == 'thanks'}" %>

        <%= link_to "🔒 非公開投稿", mypage_posts_path(filter: 'private', sort: params[:sort]),
              data: { turbo: false },
              class: "filter-btn #{'active' if params[:filter] == 'private'}" %>
      </div>

      <%= form_with url: mypage_posts_path, method: :get, local: true, class: "filter-right" do |f| %>
        <%= f.hidden_field :filter, value: params[:filter] %>
        <select name="sort" onchange="this.form.submit()" class="sort-select border-gray-300 rounded-lg px-3 py-1">
          <option value="new" <%= 'selected' if params[:sort] != 'old' %>>新しい順</option>
          <option value="old" <%= 'selected' if params[:sort] == 'old' %>>古い順</option>
        </select>
      <% end %>
    </div>

    <div class="posts-grid sm:grid-cols-2 lg:grid-cols-3 gap-6">
      <% @posts.each do |post| %>
        <div class="post-card bg-white rounded-3xl shadow-lg overflow-hidden hover:shadow-xl transition">

          <%= link_to post_path(post, from: 'mypage'),
                      data: { turbo: false, id: post.id, category: post.post_type },
                      class: "block no-underline text-gray-800" do %>

            <!-- ヘッダー（種類＋気分） -->
            <div class="post-card-header <%= post.post_type %> flex justify-between items-center px-6 py-4 border-b">

              <span class="font-semibold flex items-center gap-2">
                <%= post.post_type_icon %> <%= post.post_type_name %>

                <% if post.post_type == "organize" && post.mood.present? %>
                  <% mood_label = Post::MOODS[post.mood.to_sym][:label] %>
                  <% emoji = mood_label[/^\S+/] %>
                  <% text  = mood_label.sub(/^\S+\s*/, "") %>

                  <!-- 気分タグ（絵文字＋文字） -->
                  <span class="inline-flex items-center gap-1 text-sm font-medium px-1.5 py-0.5 bg-purple-50 text-purple-700 rounded-md">
                    <span><%= emoji %></span>
                    <span><%= text %></span>
                  </span>
                <% end %>
              </span>

              <span class="text-sm text-gray-500"><%= l post.created_at, format: :short %></span>
            </div>

            <!-- 本文 -->
            <div class="post-card-body px-6 py-4">
              <% if post.title.present? %>
                <h3 class="post-title font-bold mb-2 text-lg"><%= h(post.title) %></h3>
              <% end %>
              <p class="post-content text-gray-700 leading-relaxed">
                <%= truncate(strip_tags(post.body), length: 100) %>
              </p>
            </div>
          <% end %>

          <!-- フッター -->
          <div class="post-card-footer flex justify-between items-center text-sm text-gray-600 px-6 py-4 bg-gray-50 border-t">

            <div class="flex items-center gap-2 flex-wrap">
              <% unless post.is_public %>
                <span class="inline-block px-2 py-1 bg-gray-200 text-gray-700 rounded-full text-xs">非公開</span>
              <% end %>

              <% if post.comment_allowed? %>
                <span class="inline-block px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-bold">💬 意見募集中</span>
              <% else %>
                <span class="inline-block px-2 py-1 bg-gray-200 text-gray-700 rounded-full text-xs">💭 コメント不要</span>
              <% end %>
            </div>

            <div class="post-actions flex items-center gap-3">
              <div id="flower_btn_post_<%= post.id %>">
                <%= render "flowers/button", flowerable: post %>
              </div>

              <% if post.comment_allowed? %>
                <%= link_to post_path(post, anchor: "comment-form", from: 'mypage'),
                            data: { turbo: false },
                            class: "action-icon comment-btn flex items-center gap-1" do %>
                  💬 <span><%= post.comments.count %></span>
                <% end %>
              <% end %>
            </div>

          </div>
        </div>
      <% end %>

      <% if @posts.empty? %>
        <div class="col-span-full text-center py-12 text-gray-500">
          まだ投稿がありません。
        </div>
      <% end %>
    </div>

    <% if @posts.respond_to?(:current_page) %>
      <div class="flex justify-center mt-12">
        <%= paginate @posts %>
      </div>
    <% end %>

  </div>
</main>
