<main class="flex-grow pt-24 pb-12">
  <div class="container mx-auto max-w-6xl px-6">

    <div class="text-center mb-10">
      <h1 class="text-4xl font-bold text-gray-800 mb-2">📮 みんなの投稿一覧</h1>
      <p class="text-gray-600">心の目安箱に投函された想い</p>
    </div>

    <div class="filter-bar flex flex-col md:flex-row md:items-center md:justify-between mb-8 gap-4">
      <div class="filter-buttons flex flex-wrap items-center gap-2">
        <span class="filter-label font-semibold text-gray-700">絞り込み：</span>

        <%= link_to "すべて", posts_path(sort: params[:sort]),
              data: { turbo: false },
              class: "filter-btn #{'active' if params[:filter].blank? || params[:filter] == 'all'}" %>

        <%= link_to "🌱 未来宣言箱", posts_path(filter: 'future', sort: params[:sort]),
              data: { turbo: false },
              class: "filter-btn #{'active' if params[:filter] == 'future'}" %>

        <%= link_to "🌈 心の整理箱", posts_path(filter: 'organize', sort: params[:sort]),
              data: { turbo: false },
              class: "filter-btn #{'active' if params[:filter] == 'organize'}" %>

        <%= link_to "💌 感謝箱", posts_path(filter: 'thanks', sort: params[:sort]),
              data: { turbo: false },
              class: "filter-btn #{'active' if params[:filter] == 'thanks'}" %>
      </div>

      <%= form_with url: posts_path, method: :get, local: true, class: "filter-right" do |f| %>
        <%= f.hidden_field :filter, value: params[:filter] %>
        <select name="sort" onchange="this.form.submit()" class="sort-select border-gray-300 rounded-lg px-3 py-1">
          <option value="new" <%= 'selected' if params[:sort] != 'old' %>>新着順</option>
          <option value="old" <%= 'selected' if params[:sort] == 'old' %>>古い順</option>
        </select>
      <% end %>
    </div>

    <div id="posts-grid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6">
      <% @posts.each do |post| %>
        <div class="post-card bg-white rounded-3xl shadow-lg overflow-hidden hover:shadow-xl transition">

          <%= link_to post_path(post),
                      data: { turbo: false, id: post.id, category: post.post_type },
                      class: "block no-underline text-gray-800" do %>

            <div class="post-card-header <%= post.post_type %> flex justify-between items-center px-6 py-4 border-b">
              <span class="font-semibold"><%= post.post_type_icon %> <%= post.post_type_name %></span>
              <span class="text-sm text-gray-500"><%= l post.created_at, format: :short %></span>
            </div>

            <div class="post-card-body px-6 py-4">
              <% if post.title.present? %>
                <h3 class="post-title font-bold mb-2 text-lg"><%= h(post.title) %></h3>
              <% end %>
              <p class="post-content text-gray-700 leading-relaxed">
                <%= truncate(strip_tags(post.body), length: 100) %>
              </p>
            </div>
          <% end %>

          <div class="post-card-footer flex justify-between items-center text-sm text-gray-600 px-6 py-4 bg-gray-50 border-t">

            <!-- 左側：投稿者・非公開・コメント不要 -->
            <div class="flex items-center gap-2 flex-wrap">
              <span class="post-author"><%= post.display_name %></span>

              <% if user_signed_in? && post.user == current_user && !post.is_public %>
                <span class="inline-block px-2 py-1 bg-gray-200 text-gray-700 rounded-full text-xs">非公開</span>
              <% end %>

              <% unless post.opinion_needed? %>
                <span class="inline-block px-2 py-1 bg-gray-200 text-gray-700 rounded-full text-xs">💭 コメント不要</span>
              <% end %>
            </div>

            <!-- 右側：花ボタン + コメントボタン -->
            <% if post.is_public? %>
              <div class="post-actions flex items-center gap-3">

                <!-- 🌸 花ボタン -->
                <%= render "flowers/button", post: post %>

                <!-- 💬 コメントボタン -->
                <% if post.opinion_needed? %>
                  <%= link_to post_path(post, anchor: "comment-form"),
                              data: { turbo: false },
                              class: "action-icon comment-btn" do %>
                    💬 <span><%= post.comments.count %></span>
                  <% end %>
                <% end %>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>

      <% if @posts.empty? %>
        <div class="col-span-full text-center py-12 text-gray-500">
          まだ投稿がありません。
        </div>
      <% end %>
    </div>

    <% if @posts.respond_to?(:current_page) %>
      <div class="flex justify-center mt-12">
        <%= paginate @posts %>
      </div>
    <% end %>

  </div>
</main>
