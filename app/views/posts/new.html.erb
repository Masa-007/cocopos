<main class="flex-grow pt-24 pb-12">
  <div class="container mx-auto max-w-4xl px-6">

    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold text-gray-800 mb-2">✏️ 新しい投稿</h1>
      <p class="text-gray-600">あなたの心を投函してください</p>
    </div>

    <% if @post.errors.any? %>
      <div class="mb-6 p-4 rounded-lg border border-red-300 bg-red-50 text-red-700">
        <p class="font-bold mb-2">入力内容を確認してください：</p>
        <ul class="list-disc pl-5">
          <% @post.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <%= form_with model: @post,
      local: true,
      id: "postForm",
      data: {
        turbo: false,
        controller: "post-submit post-type-fields post-visibility",
        action: "submit->post-submit#submit change->post-type-fields#toggle change->post-visibility#check"
      } do |f| %>

      <!-- 📮 投函する箱 -->
      <div class="mb-8">
        <label class="block text-lg font-bold text-gray-800 mb-4">
          📮 投函する箱を選んでください
        </label>

        <div class="grid md:grid-cols-3 gap-4">
          <% { future: ["🌱", "未来宣言箱"],
               organize: ["🌈", "心の整理箱"],
               thanks: ["💌", "感謝箱"] }.each do |type, (icon, title)| %>

            <label class="relative cursor-pointer select-none">
              <%= f.radio_button :post_type, type,
                    class: "absolute inset-0 opacity-0 cursor-pointer peer post-type-radio",
                    required: true %>

              <div class="card-ui text-center border-2 border-gray-200 rounded-xl p-4 transition-all
                          peer-checked:border-orange-400 peer-checked:ring-2 peer-checked:ring-orange-200
                          bg-white hover:bg-orange-50">
                <div class="text-5xl mb-3"><%= icon %></div>
                <h3 class="text-xl font-bold mb-2"><%= title %></h3>
              </div>
            </label>

          <% end %>
        </div>

        <p class="text-sm text-gray-500 mt-2">
          ※ 投稿箱は投函後に変更できません
        </p>
      </div>

      <!-- 🔒 公開設定 -->
      <div class="mb-8">
        <label class="block text-lg font-bold text-gray-800 mb-4">🔒 公開設定</label>

        <div class="flex gap-4">
          <label class="flex-1 relative cursor-pointer select-none">
            <%= f.radio_button :is_public, true,
                  checked: @post.is_public != false,
                  class: "absolute inset-0 opacity-0 cursor-pointer peer" %>

            <div class="card-ui p-4 border-2 border-gray-200 rounded-xl text-center transition-all
                        peer-checked:border-orange-400 peer-checked:ring-2 peer-checked:ring-orange-200
                        bg-white hover:bg-orange-50">
              🌐<br>
              <strong>みんなに公開</strong>
              <p class="text-sm text-gray-600 mt-1">投稿一覧に表示されます</p>
            </div>
          </label>

          <label class="flex-1 relative cursor-pointer select-none">
            <%= f.radio_button :is_public, false,
                  checked: @post.is_public == false,
                  class: "absolute inset-0 opacity-0 cursor-pointer peer" %>

            <div class="card-ui p-4 border-2 border-gray-200 rounded-xl text-center transition-all
                        peer-checked:border-orange-400 peer-checked:ring-2 peer-checked:ring-orange-200
                        bg-white hover:bg-orange-50">
              🔒<br>
              <strong>非公開にする</strong>
              <p class="text-sm text-gray-600 mt-1">自分だけが見られます</p>
            </div>
          </label>
        </div>
      </div>

            <!-- 💬 コメント設定 -->
      <div class="mb-8">
        <label class="block text-lg font-bold text-gray-800 mb-4">💬 コメント設定</label>

        <div class="flex gap-4">
          <label class="flex-1 relative cursor-pointer select-none">
            <%= f.radio_button :comment_allowed, true,
                  checked: @post.comment_allowed != false,
                  class: "absolute inset-0 opacity-0 cursor-pointer peer" %>

            <div class="card-ui p-4 border-2 border-gray-200 rounded-xl text-center transition-all
                        peer-checked:border-orange-400 peer-checked:ring-2 peer-checked:ring-orange-200
                        bg-white hover:bg-orange-50">
              💬<br>
              <strong>コメントを許可する</strong>
              <p class="text-sm text-gray-600 mt-1">他の人が感想や励ましを書けます</p>
            </div>
          </label>

          <label class="flex-1 relative cursor-pointer select-none">
            <%= f.radio_button :comment_allowed, false,
                  checked: @post.comment_allowed == false,
                  class: "absolute inset-0 opacity-0 cursor-pointer peer" %>

            <div class="card-ui p-4 border-2 border-gray-200 rounded-xl text-center transition-all
                        peer-checked:border-orange-400 peer-checked:ring-2 peer-checked:ring-orange-200
                        bg-white hover:bg-orange-50">
              🚫<br>
              <strong>コメント不要</strong>
              <p class="text-sm text-gray-600 mt-1">静かに残したい投稿に</p>
            </div>
          </label>
        </div>
      </div>

      <!-- post_type別フィールド -->
      <div id="post-type-fields">
        <div data-post-type-fields-target="future" class="hidden">
          <%= render "posts/future_fields", f: f, post: @post %>
        </div>

        <div data-post-type-fields-target="organize" class="hidden">
          <%= render "posts/organize_fields", f: f, post: @post %>
        </div>

        <div data-post-type-fields-target="thanks" class="hidden">
          <%= render "posts/thanks_fields", f: f, post: @post %>
        </div>
      </div>

      <!-- AI -->
      <%= render "shared/ai_writer", post: @post %>

      <!-- 🖋 タイトル -->
      <div class="mb-8">
        <label class="block text-lg font-bold text-gray-800 mb-4">🖋 タイトル</label>
        <%= f.text_field :title,
              class: "w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-orange-400 focus:outline-none",
              maxlength: 50,
              required: true %>
        <p class="text-right text-sm text-gray-500 mt-2">50文字以内</p>
      </div>

      <!-- 📝 本文 -->
      <div class="mb-8">
        <label class="block text-lg font-bold text-gray-800 mb-4">📝 本文</label>
        <%= f.text_area :body,
              rows: 8,
              class: "w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-orange-400 focus:outline-none resize-none",
              maxlength: 1000,
              required: true %>
        <p class="text-right text-sm text-gray-500 mt-2">
          <span id="charCount">0</span> / 1000文字
        </p>
      </div>

      <div class="flex justify-center">
        <%= f.submit "投函する 📮",
              class: "px-12 py-3 bg-gradient-to-r from-orange-400 to-pink-400 text-white text-lg font-bold rounded-full hover:shadow-xl transition transform hover:scale-105" %>
      </div>

    <% end %>
  </div>
</main>

<%= render "posts/post_completion_overlay" %>
